[gd_scene load_steps=4 format=2]

[ext_resource path="res://Assets/icon.png" type="Texture" id=1]
[ext_resource path="res://Assets/box.png" type="Texture" id=2]

[sub_resource type="GDScript" id=1]
script/source = "tool
extends Node2D

signal onShootFinished()

enum {RIGHT, UP, LEFT, DOWN}
const DIRECTIONS = [
	Vector2(1, 0),
	Vector2(0, -1),
	Vector2(-1, 0),
	Vector2(0, 1)
]

export var direction = RIGHT setget setDirection

func _ready():
	add_to_group(\"lasers\")
	$Tween.connect(\"tween_all_completed\", self, \"animFinished\")	

func shootAnim():
	var from = $Laser.default_color
	from.a = 0.3
	var to = Color($Laser.default_color)
	to.a = 1.0
	var duration = 1.5 / Global.SPEED_MODIFIER
	$Tween.interpolate_property(
		$Laser, 
		\"default_color\", 
		from, 
		to, 
		duration, 
		Tween.TRANS_EXPO, 
		Tween.EASE_IN_OUT
	)
	$Tween.interpolate_property(
		$Laser, 
		\"scale\", 
		Vector2(1, .7), 
		Vector2(1, 1.5), 
		duration, 
		Tween.TRANS_EXPO, 
		Tween.EASE_IN_OUT
	)
	$Tween.start()

func animFinished():
	$Laser.scale = Vector2(1, 1)
	$Laser.default_color.a = 0.3
	var laserIntersect = getLaserIntersect()
	if laserIntersect:
		if laserIntersect.collider.is_in_group(\"players\"):
			laserIntersect.collider.onHit(3)
	emit_signal(\"onShootFinished\")

func setDirection(dir):
	direction = dir
	
func shoot():
	shootAnim()

func _process(delta):
	var laserIntersect = getLaserIntersect()
	if laserIntersect:
		$Laser.points[1] = laserIntersect.position - position

func getLaserIntersect():
	var spaceState = get_world_2d().direct_space_state
	return spaceState.intersect_ray(
		position, 
		position * DIRECTIONS[direction] * 10000
	)

func getAction():
	return Sequence.new(
		[LaserAction.new(self), Wait.new(Global.LASER_DURATION)]
	)

class LaserAction:
	extends Action
	
	var laser
	var isFinished
	
	func _init(laser):
		self.laser = laser
		laser.connect(\"onShootFinished\", self, \"finished\")
	
	func act(delta):
		.act(delta)
		if self.isFirstTime:
			laser.shoot()
		return isFinished
	
	func finished():
		isFinished = true
		"

[node name="Laser" type="Node2D"]
position = Vector2( 64, 512 )
script = SubResource( 1 )

[node name="Emitter" type="Sprite" parent="."]
scale = Vector2( 0.25, 0.25 )
z_index = 1
texture = ExtResource( 1 )

[node name="Laser" type="Line2D" parent="."]
modulate = Color( 1, 1, 1, 0.7 )
points = PoolVector2Array( 0, 0, 960, -0.768066 )
width = 5.0
default_color = Color( 1, 0, 0.631373, 0.917193 )
texture = ExtResource( 2 )
texture_mode = 1757487568

[node name="Tween" type="Tween" parent="."]
